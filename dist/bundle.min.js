!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).EchoChamber=e()}(this,(function(){"use strict";function t(t,e,n,s){return new(n||(n=Promise))((function(i,o){function r(t){try{h(s.next(t))}catch(t){o(t)}}function c(t){try{h(s.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,c)}h((s=s.apply(t,e||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;return class{constructor(t,e={}){this._socket=null,this._messageQueue=[],this._subscriptions=new Set,this._eventHandlers={},this._reconnectAttempts=0,this._pingInterval=null,this._connectionState="connecting",this._serverUrl=this._formatServerUrl(t),this._options=Object.assign({pingInterval:3e4,reconnectDelay:1e3,reconnectMultiplier:2,maxReconnectDelay:3e4,logger:(t,e,...n)=>{console.log(`EchoChamber [${t}]: ${e}`,...n)}},e),this._boundOnOpen=this._onOpen.bind(this),this._boundOnMessage=this._onMessage.bind(this),this._boundOnError=this._onError.bind(this),this._boundOnClose=this._onClose.bind(this),this.connect()}get _internalConnectionState(){return this._connectionState}set _internalConnectionState(t){this._connectionState=t}get _internalMessageQueue(){return this._messageQueue}set _internalMessageQueue(t){this._messageQueue=t}get _internalSubscriptions(){return this._subscriptions}set _internalSubscriptions(t){this._subscriptions=t}get _internalSocket(){return this._socket}set _internalSocket(t){this._socket=t}get _internalPingInterval(){return this._pingInterval}set _internalPingInterval(t){this._pingInterval=t}get _internalOptions(){return this._options}set _internalOptions(t){this._options=Object.assign(Object.assign({},this._options),t)}get _internalServerUrl(){return this._serverUrl}set _internalServerUrl(t){this._serverUrl=t}log(t,e,...n){this._options.logger(t,e,...n)}_formatServerUrl(t){if(t.startsWith("/")){return`wss://${window.location.hostname}${window.location.port?`:${window.location.port}`:""}${t}`}return t}connect(){return t(this,void 0,void 0,(function*(){this._updateConnectionState("connecting"),this._socket&&(this._socket.close(),this._socket=null),this._socket=new WebSocket(this._serverUrl),this._socket.addEventListener("open",this._boundOnOpen),this._socket.addEventListener("message",this._boundOnMessage),this._socket.addEventListener("error",this._boundOnError),this._socket.addEventListener("close",this._boundOnClose),null!==this._pingInterval&&clearInterval(this._pingInterval),this._pingInterval=setInterval((()=>this._send({action:"ping"})),this._options.pingInterval)}))}_onOpen(){var t,e;this._updateConnectionState("connected"),this._reconnectAttempts=0,this._flushQueue(),this._subscriptions.forEach((t=>this.sub(t))),null===(e=(t=this._options).onConnect)||void 0===e||e.call(t)}_onMessage(e){return t(this,void 0,void 0,(function*(){var t,n;let s;try{s=JSON.parse(e.data)}catch(t){return void this.log("error","Error parsing message",t)}if("pong"===s.action)return void this.log("info","Pong received");const i=this._eventHandlers[s.action];null==i||i.forEach((t=>t(s))),null===(n=(t=this._options).onMessage)||void 0===n||n.call(t,s)}))}_onError(t){var e,n;this._updateConnectionState("error"),null===(n=(e=this._options).onError)||void 0===n||n.call(e,t)}_onClose(){var t,e;if(this._updateConnectionState("closed"),null===(e=(t=this._options).onClose)||void 0===e||e.call(t),"connecting"!==this._connectionState){const t=Math.min(this._options.reconnectDelay*Math.pow(this._options.reconnectMultiplier,this._reconnectAttempts),this._options.maxReconnectDelay);setTimeout((()=>{this._options.reconnect&&this.connect()}),t),this._reconnectAttempts++}}_updateConnectionState(t){this._connectionState=t,this.log("info",`Connection state updated to ${t}`)}_send(e){return t(this,void 0,void 0,(function*(){var t;if((null===(t=this._socket)||void 0===t?void 0:t.readyState)===WebSocket.OPEN){const t=JSON.stringify(e);this._socket.send(t),this.log("info",`Sent: ${e.action}`,e)}else this._messageQueue.push(JSON.stringify(e))}))}_flushQueue(){this._messageQueue.forEach((t=>{var e;null===(e=this._socket)||void 0===e||e.send(t),this.log("info","Flushed message from queue")})),this._messageQueue=[]}sub(t){this._subscriptions.add(t),this._send({action:"subscribe",room:t})}unsub(t){this._subscriptions.delete(t),this._send({action:"unsubscribe",room:t})}pub(t,e){this._send({action:"publish",room:t,payload:e})}on(t,e){this._eventHandlers[t]||(this._eventHandlers[t]=[]),this._eventHandlers[t].push(e)}cleanup(){null!==this._pingInterval&&(clearInterval(this._pingInterval),this._pingInterval=null),this._socket&&(this._socket.removeEventListener("open",this._boundOnOpen),this._socket.removeEventListener("message",this._boundOnMessage),this._socket.removeEventListener("error",this._boundOnError),this._socket.removeEventListener("close",this._boundOnClose),this._socket.close(),this._socket=null),this._messageQueue=[],this._subscriptions.clear(),this._reconnectAttempts=0,this._connectionState="closed"}}}));
